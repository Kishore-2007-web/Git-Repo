<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vocabulary Flashcards</title>

  <!-- Tailwind (optional but kept) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- External SDKs (optional environments) -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      box-sizing: border-box;
      font-family: 'Poppins', -apple-system, sans-serif;
    }

    .flip-card {
      perspective: 1000px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .flip-card-back {
      transform: rotateY(180deg);
    }

    .progress-ring {
      transition: stroke-dashoffset 0.5s ease;
    }
  </style>
</head>

<body class="h-full">
<div id="app" class="w-full h-full overflow-auto"></div>

<script>
/* ==============================
   SDK FALLBACK (IMPORTANT)
================================ */
if (!window.dataSdk) {
  window.dataSdk = {
    init: async () => ({ isOk: true }),
    create: async () => ({ isOk: true }),
    update: async () => ({ isOk: true })
  };
}

if (!window.elementSdk) {
  window.elementSdk = {
    config: {},
    init: async () => {},
    setConfig: (cfg) => {
      window.elementSdk.config = { ...window.elementSdk.config, ...cfg };
    }
  };
}

/* ==============================
   CONFIG
================================ */
const defaultConfig = {
  background_color: "#0f172a",
  surface_color: "#1e293b",
  text_color: "#f1f5f9",
  primary_action_color: "#3b82f6",
  secondary_action_color: "#64748b",
  app_title: "Spanish Greetings",
  subtitle: "Master Common Phrases",
  instruction_text: "Click the card to reveal the translation",
  font_family: "Poppins",
  font_size: 16
};

/* ==============================
   DATA
================================ */
const REFERENCE_CARDS = [
  { id: "card1", front: "Hola", back: "Hello" },
  { id: "card2", front: "Buenos días", back: "Good morning" },
  { id: "card3", front: "Buenas tardes", back: "Good afternoon" },
  { id: "card4", front: "Buenas noches", back: "Good evening / night" },
  { id: "card5", front: "¿Cómo estás?", back: "How are you?" }
];

let currentCardIndex = 0;
let isFlipped = false;
let userProgress = new Map();

/* ==============================
   DATA HANDLER
================================ */
const dataHandler = {
  onDataChanged(data) {
    userProgress.clear();
    data.forEach(r => {
      userProgress.set(r.card_id, {
        times_studied: r.times_studied || 0,
        times_correct: r.times_correct || 0,
        __backendId: r.__backendId
      });
    });
    renderApp();
  }
};

/* ==============================
   INIT
================================ */
async function initializeApp() {
  await window.dataSdk.init(dataHandler);
  await window.elementSdk.init({ defaultConfig });
  renderApp();
}

/* ==============================
   RENDER
================================ */
function renderApp() {
  const config = window.elementSdk.config || defaultConfig;

  const bg = config.background_color;
  const surface = config.surface_color;
  const text = config.text_color;
  const primary = config.primary_action_color;
  const secondary = config.secondary_action_color;
  const base = config.font_size;

  const card = REFERENCE_CARDS[currentCardIndex];
  const progress = userProgress.get(card.id) || { times_studied: 0, times_correct: 0 };

  const mastery = progress.times_studied
    ? Math.round((progress.times_correct / progress.times_studied) * 100)
    : 0;

  const circumference = 2 * Math.PI * 45;
  const offset = circumference - (mastery / 100) * circumference;

  document.getElementById("app").innerHTML = `
  <div style="background:${bg};min-height:100%;padding:2rem">
    <div style="max-width:900px;margin:auto">

      <h1 style="color:${text};font-size:${base * 2}px;font-weight:700;text-align:center">
        ${config.app_title}
      </h1>
      <p style="color:${text};opacity:.7;text-align:center;margin-bottom:2rem">
        ${config.subtitle}
      </p>

      <div class="flip-card ${isFlipped ? "flipped" : ""}" style="height:400px;margin-bottom:2rem">
        <div class="flip-card-inner" id="cardInner">

          <div class="flip-card-front" style="background:${surface}">
            <svg width="100" height="100" style="position:absolute;top:1rem;right:1rem">
              <circle cx="50" cy="50" r="45" stroke="${text}" stroke-opacity="0.1" stroke-width="8" fill="none"/>
              <circle cx="50" cy="50" r="45"
                stroke="${primary}" stroke-width="8" fill="none"
                stroke-dasharray="${circumference}"
                stroke-dashoffset="${offset}"
                stroke-linecap="round"
                transform="rotate(-90 50 50)"
              />
              <text x="50" y="50" text-anchor="middle" dy=".35em"
                style="fill:${text};font-weight:600">
                ${mastery}%
              </text>
            </svg>

            <div style="opacity:.5">Spanish</div>
            <div style="font-size:${base * 2.5}px;font-weight:700">${card.front}</div>
            <div style="opacity:.4;margin-top:1rem">${config.instruction_text}</div>
          </div>

          <div class="flip-card-back" style="background:${primary}">
            <div style="opacity:.8">English</div>
            <div style="font-size:${base * 2.5}px;font-weight:700;color:white">
              ${card.back}
            </div>
          </div>

        </div>
      </div>

      <div style="display:flex;gap:1rem">
        <button id="knowBtn" ${!isFlipped ? "disabled" : ""}
          style="flex:1;background:${primary};color:white;padding:1rem;border-radius:.75rem">
          ✓ I Know This
        </button>
        <button id="dontKnowBtn" ${!isFlipped ? "disabled" : ""}
          style="flex:1;background:${secondary};color:white;padding:1rem;border-radius:.75rem">
          ✗ Still Learning
        </button>
      </div>

      <div style="display:flex;justify-content:center;gap:1rem;margin-top:1.5rem">
        <button id="prevBtn" ${currentCardIndex === 0 ? "disabled" : ""}>← Previous</button>
        <button id="nextBtn" ${currentCardIndex === REFERENCE_CARDS.length - 1 ? "disabled" : ""}>Next →</button>
      </div>

    </div>
  </div>
  `;

  document.getElementById("cardInner").onclick = () => {
    isFlipped = !isFlipped;
    renderApp();
  };

  document.getElementById("knowBtn").onclick = () => recordAnswer(true);
  document.getElementById("dontKnowBtn").onclick = () => recordAnswer(false);

  document.getElementById("prevBtn").onclick = () => {
    if (currentCardIndex > 0) {
      currentCardIndex--;
      isFlipped = false;
      renderApp();
    }
  };

  document.getElementById("nextBtn").onclick = () => {
    if (currentCardIndex < REFERENCE_CARDS.length - 1) {
      currentCardIndex++;
      isFlipped = false;
      renderApp();
    }
  };
}

/* ==============================
   RECORD ANSWER
================================ */
async function recordAnswer(correct) {
  if (!isFlipped) return;

  const card = REFERENCE_CARDS[currentCardIndex];
  const p = userProgress.get(card.id) || { times_studied: 0, times_correct: 0 };

  const record = {
    card_id: card.id,
    times_studied: p.times_studied + 1,
    times_correct: p.times_correct + (correct ? 1 : 0),
    last_studied: new Date().toISOString(),
    __backendId: p.__backendId
  };

  if (record.__backendId) {
    await window.dataSdk.update(record);
  } else {
    await window.dataSdk.create(record);
  }

  userProgress.set(card.id, record);

  if (currentCardIndex < REFERENCE_CARDS.length - 1) {
    currentCardIndex++;
  }

  isFlipped = false;
  renderApp();
}

initializeApp();
</script>
</body>
</html>
